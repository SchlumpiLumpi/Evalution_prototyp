<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Bootstrap-->
    <link crossorigin="anonymous" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--stylesheet-->
    <link rel="stylesheet" href="stylesheets/style.css">
    <!-- LEAFLET-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin>
    <!-- Make sure you put this AFTER Leaflet's CSS-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin></script>
    <!--Chart.js-->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- processed data entries-->
    <script src="data/processed_data/mortalityGeoJSON.js"></script> <!-- base_data-->
    <script src="data/processed_data/keys.js"></script> <!-- var = keys-->
    <script src="data/processed_data/keys_numerical.js"></script> <!-- var = keys_numerical-->
    <script src="data/processed_data/scatter_dataset.js"></script> <!-- var = scatter_dataset-->
    <script src="data/processed_data/statistics.js"></script> <!-- var = statistics-->
    <script src="data/processed_data/spa_results.js"></script> <!-- spa_results -->


</head>

<body>
    
<a href="/">index</a>

    <script>
        console.log(keys)
        console.log(base_data)
        console.log(scatter_dataset)
        console.log(base_data_spaAutoCorr)
    </script>

    <!-- // my functions -->
    <script type='module' defer src='javascripts/create_UI.js'></script>
    <script type='module' defer src='javascripts/map_renderer.js'></script>
    <script type='module' defer src='javascripts/dynamic_scatter_layout.js'></script>
    <script type='module' defer src='javascripts/dynamic_scatter_draw.js'></script>
    <div class="container-xl">
        <div class="row my-3">
            <div class="col-xl-10">
                <div id="map"></div>
            </div>
            
            <div class="col-2 container-fluid">
                <!-- Dropdown menu, calculating SpaAutoCorr-->
                <p>Spatial Auto Correaltion Visualizer</p>
                <div class="dropdown"><button class="btn btn-secondary dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <p>Choose</p>
                    </button>
                    <ul class="dropdown-menu" id="dropdown_menu"></ul>
                </div>
                <!-- Radiobuttons, draw Scatterplot-->
                <div id="checkbox_menu" class="container my-3"></div>
                <!-- Chatbox -->
                <div class="container">
                    <input id="keyInput" type="text" placeholder="your OpenAi apiKey">
                    <button type="button" class="btn btn-outline-primary my-1 p-1"
                        onclick="confirmKey()">confirm</button>
                </div>
                <script>
                    async function confirmKey() {
                        const keyInput = document.getElementById("keyInput")
                        const apiKey = keyInput.value
                        if (!apiKey) {
                            return
                        }
                        const response = await fetch("/apiKey", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ apiKey })
                        });
                    }
                </script>
                <div class="card bg-primary">
                    <div class="card-body">
                        Chat about your data
                    </div>
                </div>
                <div id="chatbox" class="container border rounded">
                    <div class="container-fluid" id="messages" style="height:200px"></div>
                    <input class="rounded" id="userInput" type="text" placeholder="Type a message..."></input>
                    <button type="button" class="btn btn-outline-primary my-1 p-1" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row my-3">
                <table class="table" id="charts_table"></table>
            </div>
        </div>


        <script>
            async function sendMessage() {
                const inputField = document.getElementById("userInput");
                const message = inputField.value.trim();
                if (!message) return;

                displayMessage(message, "user");
                inputField.value = "";

                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                displayMessage(data.reply, "assistant");
            }

            function displayMessage(text, sender) {
                const messagesDiv = document.getElementById("messages");
                const messageDiv = document.createElement("p");
                const authorDiv = document.createElement("p")

                authorDiv.textContent = sender

                messageDiv.textContent = text;
                messageDiv.classList.add("message", sender);
                if (sender == "user") {
                    messageDiv.setAttribute("class", "my-1 text-end")
                    authorDiv.setAttribute("class", "my-2 text-end fs-6")

                    console.log("user message")
                }
                if (sender == "assistant") {
                    messageDiv.setAttribute("class", "my-1 text-start")
                    authorDiv.setAttribute("class", "my-2 text-start fs-6")
                    console.log("assistant message")
                }
                messagesDiv.appendChild(authorDiv)
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        </script>
</body>

</html>